import{b as v,g as f,o as _}from"./api-DOepU4-1.js";import{H as g}from"./Header-B3CTn0Qr.js";import"./Modal-BJ6_-96J.js";new g(document.querySelector("#header"));const i=JSON.parse(localStorage.getItem("order_data"));i||(alert("잘못된 접근입니다. 주문할 상품이 없습니다."),history.back());const e={orderType:i.order_kind,items:[],buyer:{name:"",phone1:"",phone2:"",phone3:"",email:""},receiver:{name:"",phone1:"",phone2:"",phone3:"",address:"",detailAddress:"",message:""},paymentMethod:"card"},l=o=>o.toLocaleString(),q=async()=>{try{let o=[];if(console.log(e),e.orderType==="direct_order")console.log("direct_order",i),o.push({id:i.product_id,quantity:i.quantity});else if(e.orderType==="cart_order")if(console.log("orderdata",i),i.product_ids){const t=await v();console.log("cart: ",t),o=t.results.filter(n=>i.product_ids.includes(n.product.id)).map(n=>({id:n.product.id,quantity:n.quantity,cart_item_id:n.cart_item_id}))}else i.items&&(o=i.items);const r=await Promise.all(o.map(async t=>({...await f(t.id),quantity:t.quantity})));e.items=r,b(),S()}catch(o){console.error("Failed to load products",o),alert("상품 정보를 불러오는데 실패했습니다.")}},b=()=>{const o=document.querySelector("#product-list");o.innerHTML=e.items.map(r=>{const t=r.price*r.quantity,c=r.shipping_fee===0?"무료배송":`${l(r.shipping_fee)}원`;return console.log("item",r),`
        <div class="product-item" data-id="${r.id}">
            <div class="product-info-cell">
                <img src="${r.image}" alt="${r.name}" class="product-img" />
                <div class="product-details">
                    <span class="shop-name">${r.seller.store_name}</span>
                    <span class="product-name">${r.name}</span>
                    <span class="product-qty">수량: ${r.quantity}개</span>
                </div>
            </div>
            <div class="discount-cell">-</div>
            <div class="shipping-cell">${c}</div>
            <div class="price-cell">${l(t)}원</div>
        </div>
        `}).join("")},S=()=>{const o=e.items.reduce((c,n)=>c+n.price*n.quantity,0),r=e.items.reduce((c,n)=>c+n.shipping_fee,0),t=o+r;document.querySelector("#total-order-price-top").textContent=l(t),document.querySelector("#final-product-price").textContent=l(o),document.querySelector("#final-shipping-fee").textContent=l(r),document.querySelector("#final-total-price").textContent=l(t),p()},$=()=>{new daum.Postcode({oncomplete:function(o){e.receiver.address=o.address,document.querySelector("#postcode").value=o.zonecode,document.querySelector("#address").value=o.address,document.querySelector("#detail-address").focus(),p()}}).open()},k=o=>{const{id:r,value:t}=o.target;r==="buyer-name"&&(e.buyer.name=t),r==="buyer-phone-1"&&(e.buyer.phone1=t),r==="buyer-phone-2"&&(e.buyer.phone2=t),r==="buyer-phone-3"&&(e.buyer.phone3=t),r==="buyer-email"&&(e.buyer.email=t),r==="receiver-name"&&(e.receiver.name=t),r==="receiver-phone-1"&&(e.receiver.phone1=t),r==="receiver-phone-2"&&(e.receiver.phone2=t),r==="receiver-phone-3"&&(e.receiver.phone3=t),r==="detail-address"&&(e.receiver.detailAddress=t),r==="delivery-message"&&(e.receiver.message=t),p()},p=()=>{const o=e.buyer.name&&e.buyer.phone1&&e.buyer.phone2&&e.buyer.phone3&&e.buyer.email,r=e.receiver.name&&e.receiver.phone1&&e.receiver.phone2&&e.receiver.phone3&&document.querySelector("#postcode").value&&document.querySelector("#address").value&&e.receiver.detailAddress,t=document.querySelector("#consent-checkbox").checked,c=document.querySelector("#payment-btn");o&&r&&t?c.disabled=!1:c.disabled=!0},P=async()=>{const o=e.items.reduce((s,a)=>s+a.price*a.quantity,0),r=e.items.reduce((s,a)=>s+a.shipping_fee,0),t=o+r,c=`${e.receiver.phone1}${e.receiver.phone2}${e.receiver.phone3}`,n=`${document.querySelector("#address").value} ${e.receiver.detailAddress} (${document.querySelector("#postcode").value})`,d={receiver:e.receiver.name,receiver_phone_number:c,address:n,address_message:e.receiver.message||"배송 메시지 없음",payment_method:e.paymentMethod,total_price:t};e.orderType==="direct_order"?(d.order_kind="direct_order",d.order_type="direct_order",d.product=e.items[0].id,d.quantity=e.items[0].quantity):(d.order_kind="cart_order",d.order_kind="direct_order",e.orderType==="direct_order"?(delete d.order_kind,d.order_kind="direct_order"):(delete d.order_kind,d.order_type="cart_order",d.cart_items=e.items.map(s=>s.id)));try{await _(d),alert("주문이 완료되었습니다."),location.href="/index.html"}catch(s){console.error("Order Failed",s);let a="주문에 실패했습니다.";if(s.data){const u=[];for(const[y,m]of Object.entries(s.data)){const h=Array.isArray(m)?m.join(", "):m;y==="non_field_errors"?u.push(h):u.push(`[${y}] ${h}`)}u.length>0&&(a=u.join(`
`))}else s.message&&(a=s.message);alert(a)}},T=()=>{q(),document.querySelector("#search-address-btn").addEventListener("click",$),document.querySelectorAll("input").forEach(t=>{t.addEventListener("input",k)}),document.querySelector("#consent-checkbox").addEventListener("change",p),document.querySelectorAll("input[name='payment-method']").forEach(t=>{t.addEventListener("change",c=>{e.paymentMethod=c.target.value})}),document.querySelector("#payment-btn").addEventListener("click",P)};T();
